function obj = EKF_Estimator(InitState)
%UNTITLED 此处显示有关此函数的摘要
%   此处显示详细说明
obj = unscentedKalmanFilter(@state_trans,@measureFunc,InitState,'HasAdditiveProcessNoise',false);
obj.MeasurementNoise = 0.0001;
obj.ProcessNoise = 0.8*eye(4);
end

function x = state_trans(x,w,u)
%     S = [eye(4) zeros(4,20)];
%     E = [zeros(4) eye(4) zeros(4,16)];
      S = [eye(4) zeros(4)];
      D = [zeros(4) eye(4)];
%     F = [zeros(16,8) eye(16)];
%     %R=[-0.1*satu(s(1))-12*s(1);-0.2*satu(s(2))-2*s(2);-0.2*satu(s(3))-2*s(3);-0.2*satu(s(4))-2*s(4)];
%     Ay = [0.807457780036762,-0.0869395108606056,-0.0491985328069940,-0.0229798807247379,-1.19007956545684e-12;0.144254260942296,0.992855587123846,-0.00406233146556896,-0.00190380746807608,-9.85941742457730e-14;0.00597549531639098,0.0798069294641303,0.999889963998672,-5.16520597083132e-05,-2.67495125448865e-15;8.10603608937694e-05,0.00159805385853482,0.0399988893116096,0.999999478129315,-2.70265823153960e-17;4.09499895098082e-07,1.06588407099077e-05,0.000399995529540429,0.0199999978981604,1];
%     Az = [0.977530273201259,-0.176968084368927,-0.00208995636296630;0.248237880538457,0.977553524662979,8.63426030347947e-05;-8.01209341217095e-05,0.00193935093709528,0.970242394358159];
%     Af = [0.787863690892576,-0.238236802465420,-0.167559197403923,-0.199124638798990,-0.133107159426471,-0.141266366178469,-0.0479861299983161,-0.0289345042651481;0.286998003201597,0.961178362877248,-0.0269138030185562,-0.0327987813442234,-0.0217992184320110,-0.0233797281405867,-0.00794613214499458,-0.00481224286052170;0.0238660403377711,0.157911418783396,0.998562638192719,-0.00177365566793507,-0.00117549210050069,-0.00126719527329245,-0.000430797838552409,-0.000261444689504757;0.00129661982710908,0.0127160334216516,0.159942471773758,0.999928479071638,-4.73200157535289e-05,-5.11671230164027e-05,-1.73975200962389e-05,-1.05714555780526e-05;2.62142614750959e-05,0.000339985436704635,0.00639907928988402,0.0799988496169678,0.999999239741580,-8.23729820892628e-07,-2.80107448796485e-07,-1.70345357849373e-07;4.22408978476249e-07,6.80865311409381e-06,0.000170654388798005,0.00319998460455034,0.0799999898338049,0.999999988969196,-3.75126517255534e-09,-2.28264422615184e-09;5.66032105580537e-09,1.09020445011299e-07,3.41319300484174e-06,8.53331569006735e-05,0.00319999988356594,0.0799999998735273,0.999999999956988,-2.61843336285600e-11;3.24649223194609e-11,7.27145311454403e-10,2.73059650005310e-08,8.53332449297728e-07,4.26666660835380e-05,0.00159999999936607,0.0399999999997844,0.999999999999869];
%     By = [18.4645454006139;1.52972680099609;0.0415029047776100;0.000419327892580436;1.68884742419456e-06];
%     Bz = [0.496475761076915;-0.0205109591351436;7.06901357877594];
%     Bf = [4.59196805122556;0.763713290808676;0.0414918344674906;0.00167771273440614;2.70341746224799e-05;3.62260547571543e-07;4.15551005689100e-09;2.08371438515448e-11];
%     Cy = [690.656976612994,-45.3887172904266,-8.19801373984526,-0.264398117844535,0];
%     Cz = [0,35550.0415816234,0];
%     Cf = [0,0,138.649178471465,11.2889043906422,-8.28828481873305,-47.0536387256014,-11.3413480927752,0];
%     WA = [Ay zeros(5,11);zeros(3,5) Az zeros(3,8);zeros(8) Af];
%     WB = [By zeros(5,2); zeros(3,1) Bz zeros(3,1);zeros(8,2) Bf];
%     WC = [Cy zeros(1,11); zeros(1,5) Cz zeros(1,8);zeros(1,8) Cf];
    R = diag([-0.1 -0.2 -0.2 -0.2])*tanh((S*x)/3) - diag([-12 -2 -2 -2])*S*x;
    M=1.0e-03 *[0.1601 0 0 0;0 0.1191 0 -0.0116;0 0 0.0562 0;0 -0.0116 0 0.0667];
    new_s = S*x + (R + M*0.2*w)*0.02;
%     new_f = WA*F*x + WB*w;
%     wy = WC*new_f;
    new_d = D*x + (-0.5*M'*S*x + u + w)*0.02;
    x = [new_s;new_d];%new_f
end

function y = measureFunc(x,u)
%    C = [eye(4),zeros(4,20)];
    %C = [eye(4),zeros(4)];
    y = x;
end

% function output=satu(S)
%     if S>1
%         output=1;
%     elseif S<-1
%         output=-1;
%     else
%         output=S;
%     end
% end
